# Copyright (C) 2010 McAfee, Inc. All rights reserved
import subprocess
import sys
import os
import logging
import re
import time
#sys.path.append("../")


# Import CommonTest module into current namespace
common_path=os.path.dirname(os.path.abspath(sys.argv[0])) + "/../../"
sys.path.append(common_path + "/Common")
sys.path.append(common_path + "/AntiMalware")

import CommonAntiMalwareFns  

QATT_PATH = os.path.abspath(os.path.dirname(os.path.abspath(sys.argv[0])) + "/../data/qatt/QATestTool")

ODS_EXCLUSION_LIST       = "ODS_Exclusion_List"
AV_PRIMARY_ACTION        = "ODS_AV_ScannerPrimaryAction"
AV_SECONDARY_ACTION      = "ODS_AV_ScannerSecondaryAction"
SPYWARE_PRIMARY_ACTION   = "ODS_Spyware_ScannerPrimaryAction"
SPYWARE_SECONDARY_ACTION = "ODS_Spyware_ScannerSecondaryAction"
SCAN_ARCHIVE             = "ODS_ScanArchive"
SCAN_MAIL                = "ODS_ScanMail"


def enableArchiveScanning():
    """
    Enables the scanning of archive files.
    RETURN : True on success, False Otherwise.
    """
    return CommonAntiMalwareFns.setKey(SCAN_ARCHIVE, '1')

def disableArchiveScanning():
    """
    Disables the scanning of archive files.
    RETURN : True on success, False Otherwise.
    """
    return CommonAntiMalwareFns.setKey(SCAN_ARCHIVE,'0')

def isArchiveScanningEnabled():
    """
    Return True if archive scanning is enabled. False otherwise.
    """
    return CommonAntiMalwareFns.getKey(SCAN_ARCHIVE) in ["true"]

def enableMailScanning():
    """
    Enables the Apple Mail scanning.
    RETURN : True on success, false otherwise.
    """
    return CommonAntiMalwareFns.setKey(SCAN_MAIL,'1')

def disableMailScanning():
    """
    Disables the Apple Mail Scanning.
    RETURN : True on succwss. False otherwise.
    """
    return CommonAntiMalwareFns.setKey(SCAN_MAIL,'0')

def isMailScanningEnabled():
    """
    Return True if Apple-Mail scanning is enabled. False otherwise.
    """
    return CommonAntiMalwareFns.getKey(SCAN_MAIL) in ["true"]



def getAVPrimaryAction():
    """
    Returns the AV's Primary Action.
    RETURN : '1' - for Clean
             '2' - for delete
             '3' - for Quarantine
             '0' - for notify
             None if failed to find the action.
    NOTE: Return is a string and not integer
    """
    return CommonAntiMalwareFns.getKey(AV_PRIMARY_ACTION)

def setAVPrimaryAction(val):
    """
    Sets the primary action of the AV.
    PARAM : string with values :
            '1' - Clean
            '2' - Delete
            '3' - Quarantine
            '0' - Notify
    RETURN : True for success. False otherwise
    """
    if not isinstance(val,str) or val not in ['1','2','3','0']:
        logging.error("setAVPrimaryAction : Argument 'val' must be string")
        return False

    if val == '2':
        CommonAntiMalwareFns.setKey(AV_SECONDARY_ACTION, '0')
    elif val == '0':
        CommonAntiMalwareFns.setKey(AV_SECONDARY_ACTION, '0')
        
    return CommonAntiMalwareFns.setKey(AV_PRIMARY_ACTION, val);

def getAVSecondaryAction():
    """
    Returns the AV's secondary action
    RETURN : '0' - Notify
             '1' - Clean
             '2' - Delete
             '3' - Quarantine
    """
    return CommonAntiMalwareFns.getKey(AV_SECONDARY_ACTION)

def setAVSecondaryAction(val):
    """
    Sets the secondary action of the AV.
    PARAM : string with values :
            '0' - Notify
            '1' - Clean
            '2' - Delete
            '3' - Quarantine
    RETURN : True for success. False otherwise
    """
    if not isinstance(val,str) or val not in ['0','1','2','3']:
        logging.error("setAVSecondaryAction : Argument 'val' must be string")
        return False
    return CommonAntiMalwareFns.setKey(AV_SECONDARY_ACTION, val)

def getSpywarePrimaryAction():
    """
    Returns the Spyware's Primary Action.
    RETURN : '1' - for Clean
             '2' - for Delete
             '3' - for Quarantine
             '0' - for notify
             None if failed to find the action.
    NOTE: Return is a string and not integer
    """
    return CommonAntiMalwareFns.getKey(SPYWARE_PRIMARY_ACTION)

def getSpywareSecondaryAction():
    """
    Returns the AV's secondary action
    RETURN : '1' - Clean
             '2' - Delete
             '3' - Quarantine
             '0' - Notify
    """
    return CommonAntiMalwareFns.getKey(SPYWARE_SECONDARY_ACTION)

def setSpywarePrimaryAction(val):
    """
    Sets the primary action of the Spyware.
    PARAM : string with values :
            '1' - Clean
            '2' - Quarantine
            '3' - Delete
            '0' - Notify
    RETURN : True for success. False otherwise
    """
    if not isinstance(val,str) or val not in ['1','2','3','0']:
        logging.error("setSpywarePrimaryAction : Argument 'val' must be string")
        return False

    if val == '2':
        CommonAntiMalwareFns.setKey(SPYWARE_SECONDARY_ACTION, '0')
    elif val == '0':
        CommonAntiMalwareFns.setKey(SPYWARE_SECONDARY_ACTION, '0')
        
    return CommonAntiMalwareFns.setKey(SPYWARE_PRIMARY_ACTION,val)

def setSpywareSecondaryAction(val):
    """
    Sets the secondary action of the Spyware.
    PARAM : string with values :
            '1' - Clean
            '2' - Quarantine
            '3' - Delete
            '0' - Notify
    RETURN : True for success. False otherwise
    """
    if not isinstance(val,str) or val not in ['0','1','2','3']:
        logging.error("setSpywareSecondaryAction : Argument 'val' must be string")
        return False

    return CommonAntiMalwareFns.setKey(SPYWARE_SECONDARY_ACTION, val)


def addODSExclusion(exclusion):
    """
    Adds the given exclusion to ODS exclusion list.
    If the exclusion path already exist, it return True without doing anything.
    PARAM : string containing the path of exclusion.
    RETURN : True for success and false otherwise.
    """
    if not isinstance(exclusion, str) :
        logging.error("addODSExclusion : parameter exclusion must be a string")
        return False
    _exclusions = getODSExclusions()
    # if already present :
    if exclusion in _exclusions  :
        return True
    _exclusions.append(exclusion)
    return setODSExclusions(_exclusions)

def setODSExclusions(exclusions):
    """
    Sets the ODS exclusion list.
    PARAM : list of string containing the exclusions to be set.
    RETURN : True on success. False otherwise.
    """
    if not isinstance(exclusions,list) :
        logging.error("setODSExclusions : parameter exclusions must be a list")
        return False
    for _e in exclusions :
        if not isinstance(_e, str) :
            logging.error("setODSExclusions: element of list must be a string")
            return False

    _exclusions = ""
    for _exclusion in exclusions :
        if len(_exclusions) == 0:
            _exclusions = _exclusion
        else:
            _exclusions = _exclusions + " " + _exclusion + " "
    return CommonAntiMalwareFns.setKey(ODS_EXCLUSION_LIST, _exclusions)

def deleteODSExclusion(exclusion):
    """
    Delete the given ODS exclusion.
    PARAM : string containing exclusion to remove.
    RETURN : True for success. False otherwise

    """
    if not isinstance(exclusion) :
        logging.error("deleteODSExclusion : parameter 'exclusion' must be string")

    _exclusions = getODSExclusions()
    if exclusion not in _exclusions :
        logging.debug("deleteODSExclusion : %s not found in exclusion list" % exclusion)
        return False
    for _exclusion in _exclusions :
        if _exclusion != exclusion :
            _str_exclusions = _str_exclusions + " '" + _exclusion +"'"
    return CommonAntiMalwareFns.setKey(ODS_EXCLUSION_LIST, _exclusions)

def getODSExclusions():
    """
    Returns the ODS exclusion list.
    RETURN : list of strings containing exclusions
             None on failure
    """
    try :
        _p = subprocess.Popen([QATT_PATH, "2", ODS_EXCLUSION_LIST],
                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        if _p is None :
            logging.error("Unable to create the QATT process")
            return None
        # Wait till process complete.
        _p.wait()

        # Read the output and parse it.
        _out = _p.stderr.read().split("\n")
        _regex = "\{contents\s+=\s+\"(.*)\"\s*\}"
        _exclusions = []
        for _line in _out :
            _match = re.search(_regex, _line)
            if _match is not None and _match.group(1) != ODS_EXCLUSION_LIST :
                _exclusions.append(_match.group(1))

        return _exclusions
    except :
        logging.error("getODSExclusions : Failed with exception")
    return None
def setODSScanNow(path):
    try:
        _cmd = QATT_PATH + " 9"+" Scan"+" 1000"+" 0"+" 0 "+path
        retval = subprocess.call(["/bin/sh", "-c",_cmd],stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        if retval != 0:
            logging.error("Unable to create the QATT process")
            return False
        return True
    except:
        logging.error("Unable to create the QATT process")
        return False
        
  
